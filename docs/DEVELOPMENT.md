# HWHKit-Go 开发指南

## 项目概述

HWHKit-Go 是一个功能完整的Go Web开发工具库，包含了现代Web应用开发所需的核心组件。

## 核心模块

### 1. 配置管理 (pkg/config)
- 支持环境变量和.env文件
- 支持远程配置API
- 完整的配置结构体定义
- 测试覆盖

### 2. 日志管理 (pkg/logger)
- 基于logrus的结构化日志
- 支持多种输出格式（JSON/Text）
- 支持多种输出目标（控制台/文件/组合）
- 日志轮转支持
- 完整的测试覆盖

### 3. 数据库管理 (pkg/database)
- 支持MySQL和PostgreSQL
- 基于GORM的ORM封装
- 连接池管理
- 自动迁移支持
- 事务支持
- 健康检查

### 4. 缓存管理 (pkg/cache)
- Redis缓存支持
- 连接池管理
- 支持各种Redis数据类型
- JSON序列化支持
- 管道和事务操作

### 5. JWT认证 (pkg/auth)
- 完整的JWT令牌管理
- 访问令牌和刷新令牌
- 角色权限验证
- 令牌过期检查
- 声明信息提取

### 6. 中间件 (pkg/middleware)
- CORS中间件
- JWT认证中间件
- 日志记录中间件
- 限流中间件
- 角色验证中间件
- 中间件组合管理

### 7. HTTP服务器 (pkg/server)
- 基于Gin的服务器封装
- 优雅关闭支持
- 健康检查端点
- 路由管理器
- API路由构建器

### 8. 工具函数 (pkg/utils)
- 字符串处理工具
- JSON操作工具
- 时间处理工具
- HTTP客户端工具

## 开发环境设置

### 1. 克隆项目
```bash
git clone <repository>
cd hwhkit-go
```

### 2. 安装依赖
```bash
make install
```

### 3. 安装开发工具
```bash
make dev-tools
```

### 4. 设置环境配置
```bash
cp .env.example .env
# 编辑 .env 文件设置数据库和Redis连接信息
```

## 开发工作流

### 1. 代码格式化
```bash
make fmt
```

### 2. 代码检查
```bash
make lint
```

### 3. 运行测试
```bash
make test
# 或详细输出
make test-v
```

### 4. 运行基准测试
```bash
make bench
```

### 5. 生成测试覆盖率报告
```bash
make coverage
```

### 6. 构建应用
```bash
make build
```

### 7. 运行应用
```bash
make run
```

## 测试策略

### 单元测试
- 每个包都有对应的测试文件
- 使用testify库进行断言
- 测试覆盖率目标：>80%

### 集成测试
- 测试各模块之间的集成
- 测试完整的应用栈

### 基准测试
- 性能关键的函数有基准测试
- 监控性能回归

## 代码规范

### 1. 包结构
```
pkg/
├── module/           # 模块名
│   ├── manager.go   # 主要实现
│   ├── types.go     # 类型定义（如需要）
│   └── manager_test.go # 测试文件
```

### 2. 命名规范
- 包名：小写，简短
- 文件名：小写，下划线分隔
- 函数名：驼峰命名，导出函数首字母大写
- 变量名：驼峰命名
- 常量：大写，下划线分隔

### 3. 注释规范
- 所有导出的函数都要有注释
- 注释以函数名开头
- 复杂逻辑要有内部注释

### 4. 错误处理
- 使用fmt.Errorf包装错误
- 提供有意义的错误消息
- 不要忽略错误

## 部署

### Docker部署
```bash
make docker
```

### 手动部署
```bash
make build
./bin/hwhkit-app
```

## 监控和健康检查

应用提供以下健康检查端点：

- `/health` - 整体健康状态
- `/health/live` - 存活检查
- `/health/ready` - 就绪检查
- `/metrics` - 指标信息

## 性能优化

### 1. 数据库优化
- 使用连接池
- 合理设置最大连接数
- 使用事务批量操作

### 2. 缓存优化
- 合理设置缓存过期时间
- 使用管道操作批量处理
- 监控缓存命中率

### 3. HTTP服务器优化
- 使用限流中间件
- 合理设置超时时间
- 启用GZIP压缩（如需要）

## 扩展指南

### 添加新模块
1. 在pkg/下创建新目录
2. 实现Manager模式
3. 添加对应的测试
4. 更新README文档

### 添加新中间件
1. 在pkg/middleware/下添加文件
2. 实现gin.HandlerFunc
3. 添加配置结构体
4. 添加测试用例

### 添加新工具函数
1. 在pkg/utils/下添加或扩展文件
2. 创建对应的结构体和方法
3. 添加全局实例
4. 添加测试用例

## 故障排除

### 常见问题

1. **数据库连接失败**
   - 检查数据库配置
   - 确认数据库服务运行状态
   - 检查网络连接

2. **Redis连接失败**
   - 检查Redis配置
   - 确认Redis服务运行状态
   - 检查认证信息

3. **JWT验证失败**
   - 检查JWT密钥配置
   - 确认令牌格式正确
   - 检查令牌是否过期

### 调试技巧

1. 启用调试日志
```bash
export LOG_LEVEL=debug
```

2. 使用健康检查端点
```bash
curl http://localhost:8080/health
```

3. 查看详细错误信息
- 检查应用日志
- 使用结构化日志搜索

## 贡献指南

1. Fork项目
2. 创建特性分支
3. 提交更改
4. 添加测试
5. 更新文档
6. 提交Pull Request

## 版本管理

使用语义化版本：
- MAJOR: 不兼容的API更改
- MINOR: 向后兼容的功能添加
- PATCH: 向后兼容的bug修复